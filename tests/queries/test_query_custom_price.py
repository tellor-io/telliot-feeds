from eth_abi import decode

from telliot_feeds.queries.custom_price import CustomPrice


def test_custom_price_query_info():
    """Validate CustomPrice query construction."""
    q = CustomPrice(
        identifier="landx",
        asset="corn",
        currency="usd",
        unit="per_kilogram",
    )

    # expected query data generated with:
    expected_query_data = (
        "000000000000000000000000000000000000000000000000000000000000004"
        "0000000000000000000000000000000000000000000000000000000000000008"
        "0000000000000000000000000000000000000000000000000000000000000000b"
        "437573746f6d507269636500000000000000000000000000000000000000000000"
        "0000000000000000000000000000000000000000000000000000000000018000000"
        "00000000000000000000000000000000000000000000000000000000080000000000"
        "00000000000000000000000000000000000000000000000000000c000000000000000"
        "0000000000000000000000000000000000000000000000010000000000000000000000"
        "00000000000000000000000000000000000000000140000000000000000000000000000"
        "00000000000000000000000000000000000056c616e64780000000000000000000000000"
        "0000000000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000004636f726e000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000000000000000000000000"
        "375736400000000000000000000000000000000000000000000000000000000000000000000"
        "00000000000000000000000000000000000000000000000000000c7065725f6b696c6f6772616d"
        "0000000000000000000000000000000000000000"
    )

    assert q.query_data.hex() == expected_query_data
    assert q.query_id.hex() == "6972aeebf15f6c9543b2cb717b9f0340e9a71ad9d07642db7f7a8992088b25e8"

    query_type, _ = decode(["string", "bytes"], q.query_data)
    assert query_type == "CustomPrice"
